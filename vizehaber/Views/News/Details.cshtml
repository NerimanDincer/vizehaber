@using System.Security.Claims
@model vizehaber.Models.News

@{
    ViewData["Title"] = Model.Title;
    Layout = "~/Views/Shared/_LayoutAdmin.cshtml";
}

<div class="container my-5">
    <div class="row">
        <div class="col-lg-8">

            <h1 class="font-weight-bold mb-3">@Model.Title</h1>

            <div class="d-flex align-items-center flex-wrap mb-4">

                <span class="text-muted mr-3">
                    <i class="far fa-calendar-alt"></i> @Model.PublishedDate.ToString("dd MMMM yyyy")
                </span>

                <span class="text-muted mr-3">
                    <i class="fas fa-folder"></i> @Model.Category.Name
                </span>

                <span class="text-muted mr-3">
                    <i class="fas fa-user"></i> @(Model.AppUser?.FullName ?? "Editör")
                </span>

                @{
                    // Şu an siteye giren kişinin ID'sini alıyoruz
                    var currentUserId = User.FindFirstValue(ClaimTypes.NameIdentifier);

                    // KURAL: Kullanıcı Admin ise VEYA Yazının sahibi kendisi ise GÖRSÜN
                    bool canSeeStats = User.IsInRole("Admin") || (currentUserId == Model.AppUserId);
                }

                @if (canSeeStats)
                {
                    <span class="mr-3" title="Bu istatistiği sadece siz ve yöneticiler görebilir">
                        <i class="fas fa-eye text-warning"></i> @Model.ViewCount
                    </span>
                }

            </div>

            @if (!string.IsNullOrEmpty(Model.ImagePath))
            {
                <img src="@Model.ImagePath" class="img-fluid rounded shadow-sm mb-4 w-100" alt="@Model.Title">
            }

            <div class="news-content" style="font-size: 1.1rem; line-height: 1.8;">
                @Html.Raw(Model.Content)
                <div class="mt-4 mb-4">
                    <h6 class="text-muted font-weight-bold mb-3">Haberi Paylaş:</h6>

                    <a href="https://api.whatsapp.com/send?text=@Model.Title - @Context.Request.Scheme://@Context.Request.Host@Context.Request.Path"
                       target="_blank" class="btn btn-success btn-sm rounded-circle mr-2" title="WhatsApp'ta Paylaş">
                        <i class="fab fa-whatsapp"></i>
                    </a>

                    <a href="https://twitter.com/intent/tweet?text=@Model.Title&url=@Context.Request.Scheme://@Context.Request.Host@Context.Request.Path"
                       target="_blank" class="btn btn-dark btn-sm rounded-circle mr-2" title="Twitter'da Paylaş">
                        <i class="fab fa-twitter"></i>
                    </a>

                    <a href="https://www.facebook.com/sharer/sharer.php?u=@Context.Request.Scheme://@Context.Request.Host@Context.Request.Path"
                       target="_blank" class="btn btn-primary btn-sm rounded-circle" title="Facebook'ta Paylaş">
                        <i class="fab fa-facebook-f"></i>
                    </a>
                </div>
            </div>

            <hr class="my-5">

            <div class="comments-section">
                <h3 class="mb-4"><i class="fas fa-comments"></i> Yorumlar (@Model.Comments.Count)</h3>

                @if (Model.Comments.Count > 0)
                {
                    @foreach (var comment in Model.Comments.OrderByDescending(c => c.CreatedDate))
                    {
                        <div class="media mb-4 p-3 rounded" style="background-color: #f8f9fa;">
                            <img class="d-flex mr-3 rounded-circle"
                                 src="@(comment.AppUser?.PhotoUrl ?? "/sbadmin/img/undraw_profile.svg")"
                                 width="50" height="50" style="object-fit: cover;" alt="">

                            <div class="media-body">
                                <h5 class="mt-0 font-weight-bold text-dark">
                                    @(comment.AppUser?.FullName ?? "Anonim Kullanıcı")
                                    <small class="text-muted ml-2" style="font-size: 0.8rem;">
                                        @comment.CreatedDate.ToString("dd.MM.yyyy HH:mm")
                                    </small>
                                </h5>
                                @comment.Text
                            </div>
                        </div>
                    }
                }
                else
                {
                    <div class="alert alert-info">
                        Henüz yorum yapılmamış. İlk yorumu sen yap! 🚀
                    </div>
                }

                <div class="card my-4 shadow-sm border-0">
                    <h5 class="card-header bg-white border-0 font-weight-bold">Yorum Bırak</h5>
                    <div class="card-body">

                        @if (User.Identity.IsAuthenticated)
                        {
                            <form asp-action="AddComment" method="post" id="commentForm">
                                <input type="hidden" name="newsId" value="@Model.Id" />

                                <div class="form-group">
                                    <textarea class="form-control" name="text" rows="3"
                                          placeholder="Düşüncelerini paylaş..." required></textarea>
                                </div>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-paper-plane"></i> Gönder
                                </button>
                            </form>
                        }
                        else
                        {
                            <div class="text-center py-3">
                                <p class="mb-3">Yorum yapabilmek için giriş yapmalısınız.</p>
                                <a href="/Account/Login" class="btn btn-outline-primary">
                                    <i class="fas fa-sign-in-alt"></i> Giriş Yap
                                </a>
                                <a href="/Account/Register" class="btn btn-outline-secondary">
                                    Kayıt Ol
                                </a>
                            </div>
                        }
                    </div>
                </div>

            </div>

        </div>

        <div class="col-lg-4">
        </div>
    </div>
</div>